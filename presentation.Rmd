---
title: "Labor Force and the American Dream"
author: "Justin M. Shea"
date: "September 12, 2017"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(rmarkdown)
library(xts)
library(ggplot2)
library(blscrapeR)
library(tidyr)
library(ggthemes)
library(tufte)
library(RColorLisa)
library(dplyr)

source("functions.R")

library(RColorLisa)

Picasso <- color.lisa.pal(5, "The Dream by Pablo Picasso")
Basquiat <- color.lisa.pal(4, "DUSTHEADS by Jean-Michel Basquiat")
vanGogh <- color.lisa.pal(4, "The Starry Night by Vincent van Gogh")
chagall <- color.lisa.pal(4, "La MariÃ©e sous le Baldaquin by Marc Chagall")

```

## Introduction
```{r, message = FALSE, warning = FALSE, cache = TRUE}
df <- get_bls_county()
```
```{r, message = FALSE, warning = FALSE}
#Use map function with arguments.
map_bls(map_data = df, fill_rate = "unemployed_rate", 
        labtitle = "Unemployment Rate by County")
```

## Unemployment Rate

```{r message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Series ID: UNRATE LNS14000000"}
# Employment Statistics
Unemployment_url <- "https://fred.stlouisfed.org/data/UNRATE.txt"

Unemployment <- as.xts(read.zoo(Unemployment_url, skip = 24, index.column = 1, 
                            header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))

Unemployment_chart <- data.frame(date = index(Unemployment["1980/"]), value = coredata(Unemployment["1980/"]))

ggplot(data = Unemployment_chart, aes(y = value, x = date)) +
        geom_line(color = Picasso[1]) +
        scale_y_continuous(position = "right") +
        xlab("Year") +
        ylab("Percent") +
       geom_vline(xintercept = 2000, alpha = 1/3, linetype = "dashed") +
        scale_color_manual(values = Picasso) +
        theme_tufte(base_size = 16) + theme(legend.position = "top")
```

## Labor Force Participation Rate

```{r message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Series ID: CIVPART LNS11300000"}
labor_participation_url <- "https://fred.stlouisfed.org/data/CIVPART.txt"

labor_participation <- as.xts(read.zoo(labor_participation_url, skip = 14, index.column = 1, 
                                   header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon))

Participation_chart <- data.frame(date = index(labor_participation["1980/"]), value = coredata(labor_participation["1980/"]))

ggplot(data = Participation_chart, aes(y = value, x = date)) +
        geom_line(color = Picasso[1]) +
        scale_y_continuous(position = "right") +
        xlab("Year") +
         ylab("Percent") +
        #geom_vline(xintercept = c(1990, 1994, 2002, 2010), alpha = 1/3, linetype = "dashed") +
        scale_color_manual(values = Picasso) +
        theme_tufte(base_size = 16) + theme(legend.position = "top")
```

## The labor participation rate, by age

```{r message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Series ID: CIVPART LNS11300000"}
#bls data by ages
library(blscrapeR)

employment_series <- c("LNS11324230", "LNS11300093", "LNS11300091", "LNS11300089", "LNS11324887" )
labels <- c("55 and over", "45 to 55", "35 to 44", "25 to 34", "16 to 24")

employment_ages <- bls_api(employment_series, startyear = 1997, end = 2017, registrationKey = Sys.getenv("BLS_KEY")) %>% 
        dateCast()

employment_wide <- employment_ages %>% spread(seriesID, value) %>% select(5:10) %>%
        arrange(date)
        
employment_diff <- apply(employment_wide[,2:6], 2, diff)

employment_sum <- apply(employment_diff, 2, cumsum)

employment_final <- data.frame(employment_wide[-1,"date"], employment_sum) %>%
         rename("55 and over"=LNS11324230, "45 to 55" = LNS11300093, "35 to 44" = LNS11300091,
                "25 to 34" = LNS11300089, "16 to 24" = LNS11324887)
        
employment_long <- gather(employment_final, "age", "percent", 2:6)

  ggplot(employment_long, aes(x=date, y=percent)) +
        geom_line(aes(colour = age), size = 1) +
        scale_y_continuous(position = "right") +
        xlab("Year") +
         ylab("Percent") +
        geom_hline(yintercept = 0, alpha = 2/3, linetype = "dashed") +
        scale_color_manual(values = Picasso) +
        theme_tufte(base_size = 16) + theme(legend.position = "top")

```

## Perhaps it's the output gap

```{r, message=FALSE, warning=FALSE}
Real_GDP_URL <- "https://research.stlouisfed.org/fred2/data/GDPC96.txt"
Real_GDP <- as.xts(read.zoo(Real_GDP_URL, skip = 12, index.column = 1, 
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

HL_GDP_actual <- HLfilter(Real_GDP, h = 64)

Gap_Percent <- 100 * (sum(HL_GDP_actual["2017"]$HL_resid) / sum(HL_GDP_actual["2017"]$x_h))
#kable(Gap_Percent)

# log real gdp for plots
Hlm_GDP <- HLfilter.lm(Real_GDP["/2007"], h = 80)
HL_GDP <- HLfilter(100*log(Real_GDP), h = 40)


# plot GDP
#plot(HL_GDP$HL_fit, col = "red", grid.col = "white")
#lines(HL_GDP$x_h, col = "black")

plot(HL_GDP$HL_fit["1984/"], col = "red", grid.col = "white")
lines(HL_GDP$x_h["1984/"], col = "black")
```

## Output gap
```{r, message=FALSE, warning=FALSE}
# plot resid
plot(HL_GDP$HL_resid["1956/"], index(employ_hlf), col = "black", grid.col = "white")
abline(v = .index(HL_GDP["2001"])[1], lty = 2, col = "green")
abline(v = .index(HL_GDP["2009"])[1], lty = 2, col = "red")
#abline(h = 415, lty = 2, col = "green")
abline(h = 0, lty = 2, col = "black")
#abline(h= -515, lty = 2, col = "red")
```


## Government Spending
```{r, message = FALSE, warning = FALSE, tidy = TRUE}
### Government Consumption Expenditures
                        Federal_GCE <- "https://fred.stlouisfed.org/data/FGCE.txt"
                    State_Local_GCE <- "https://fred.stlouisfed.org/data/SLCE.txt"
                    
## GCE Quantity & Price Indexes
Federal_Quantity_Index <- "https://fred.stlouisfed.org/data/B823RA3Q086SBEA.txt"
        Federal_Price_Index <- "https://fred.stlouisfed.org/data/B823RG3Q086SBEA.txt"
#-------------------------------------#
State_Local_Quantity_Index <- "https://fred.stlouisfed.org/data/B829RA3Q086SBEA.txt"
        State_Local_Price_Index <- "https://fred.stlouisfed.org/data/B829RG3Q086SBEA.txt"
        
GCE_Table <- t(data.frame(Federal_GCE, Federal_Quantity_Index, Federal_Price_Index, State_Local_GCE, State_Local_Quantity_Index, State_Local_Price_Index))
#kable(GCE_Table, align = "l", caption = "GCE Nominal, Quantity, and Price index sources.")
```

```{r, message = FALSE, warning = FALSE, tidy = TRUE}
Federal          <- as.xts(read.zoo(Federal_GCE, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Federal_Quantity <- as.xts(read.zoo(Federal_Quantity_Index, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
Federal_Price    <- as.xts(read.zoo(Federal_Price_Index  , sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
#------------------------------# 
State_Local          <- as.xts(read.zoo(State_Local_GCE, sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
State_Local_Quantity <- as.xts(read.zoo(State_Local_Quantity_Index, sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
State_Local_Price    <- as.xts(read.zoo(State_Local_Price_Index  , sep = "", skip = 13, 
                              index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
```


```{r message = FALSE, warning = FALSE, tidy = TRUE}
Real_Federal      <- Fisher(Federal, Federal_Price, Federal_Quantity, 249)
Real_State_Local  <- Fisher(State_Local, State_Local_Price, State_Local_Quantity, 249)
```

```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Real Federal and Local Spending, 1980-Present"}
library(ggplot2)
library(RColorLisa)

Government <- merge(Real_Federal,Real_State_Local)

Picasso <- color.lisa.pal(5, "The Dream by Pablo Picasso")
Basquiat <- color.lisa.pal(4, "DUSTHEADS by Jean-Michel Basquiat")
vanGogh <- color.lisa.pal(4, "The Starry Night by Vincent van Gogh")
chagall <- color.lisa.pal(4, "La MariÃ©e sous le Baldaquin by Marc Chagall")

autoplot(Government["1980/"], facets = Series ~., melt=TRUE) +
        scale_y_continuous(position = "right") +
        xlab("Year") +
        geom_vline(xintercept = c(1990, 1994, 2002, 2010), alpha = 1/3, linetype = "dashed") +
        scale_color_manual(values = Picasso) +
        theme_tufte() + theme(legend.position = "top")

```

```{r}
# GDP
GDP_and_Gov <- merge(Real_GDP, Real_Federal, Federal, Real_State_Local, State_Local)
Government_table <- data.frame(coredata(GDP_and_Gov ["2010/"]))
rownames(Government_table) <- index(GDP_and_Gov["2010/"]) 
#kable(Government_table)


total_table <- data.frame(sapply(Government_table, function(x) (x[NROW(x)] - x[1])))
summary_table <- t(total_table)
rownames(summary_table) <- "Change from 2010"
#kable(summary_table)
```

## Real Government Spending, Percentage of Real GDP

```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Real Federal Consumption Expenditure: Percentage of Real GDP"}
Federal_GDP_percent <- 100 * (Real_Federal/Real_GDP)

autoplot(Federal_GDP_percent["1980/"]) +
        ylab("Federal GCE, % GDP") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_vline(xintercept = c(1990, 1994, 2002, 2010)) +
        theme_bw()
```

## Isn't the stock market doing well?



## Corporate Profits, Percentage of Real GDP


```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Real Federal Consumption Expenditure: Percentage of Real GDP"}

GDP_nom <- "https://fred.stlouisfed.org/data/GDP.txt"
GDP          <- as.xts(read.zoo(GDP_nom, skip = 19, index.column = 1, header = TRUE, 
                       format = "%Y-%m-%d", FUN = as.yearqtr))


### Income Savings ###
Corporate_Profits_After_Tax <- "https://fred.stlouisfed.org/data/CP.txt"
Corporate_Net_Cash_Flow     <- "https://fred.stlouisfed.org/data/CNCF.txt"

### Download 

Corporate_Profits   <-  as.xts(read.zoo(Corporate_Profits_After_Tax, sep = "", skip = 10, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", 
                           FUN = as.yearqtr))
Corporate_Cash_Flow <-  as.xts(read.zoo(Corporate_Net_Cash_Flow, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", 
                           FUN = as.yearqtr))     

Corporate_GDP_percent <- 100 * (Corporate_Cash_Flow/GDP)

autoplot(Corporate_GDP_percent["2000/"]) +
        ylab("Corporate Cash Flow, % GDP") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_vline(xintercept = c(2008)) +
        theme_bw()
```

## Percentage of Corporate Cash Flows, Not Profits

```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Corporate Profits: Percentage of Corporate Cash Flow"}

Corporate_Net_Cash_Flow     <- "https://fred.stlouisfed.org/data/CNCF.txt"


Corporate_Cash_Flow <-  as.xts(read.zoo(Corporate_Net_Cash_Flow, sep = "", skip = 13, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", 
                           FUN = as.yearqtr))     

Corp_Cash_GDP_percent <- 100 * (Corporate_Profits/Corporate_Cash_Flow)

autoplot(Corp_Cash_GDP_percent["1982/"]) +
        ylab("Corporate Profits, % of Corporate Cash Flow") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_vline(xintercept = c(2008)) +
        theme_bw()

```


```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Corporate Cash Flows without profits: Percentage of Real GDP"}
cash_profit <- 100 * (Corporate_Cash_Flow-Corporate_Profits)/GDP

autoplot(cash_profit["1982/"]) +
        ylab("Corporate Profits, % of Corporate Cash Flow") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_vline(xintercept = c(2008)) +
        theme_bw()

```

```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "S&P 500 Earnings Per Share, Percent from New Sales"}

library(Quandl)
Quandl.api_key("wzAyVxVa7H7Rj1xZqy6V")
SP500_Sales <- Quandl("MULTPL/SP500_REAL_SALES_YEAR", type="xts")
SP500_Earnings <- Quandl("MULTPL/SP500_EARNINGS_YEAR", type="xts")

SP500_Profit <- (SP500_Sales-SP500_Earnings)/SP500_Earnings

autoplot(SP500_Profit["2000/"]) +
        ylab("Earnings, % New Sales Per share") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_smooth(method = "lm") +
        theme_bw()
```

## Productivity



## Minimum wage

```{r, message = FALSE, warning = FALSE, cache = TRUE}

minimum_oath <- "https://fred.stlouisfed.org/data/FEDMINNFRWG.txt"
minimum_wage <-  as.xts(read.zoo(minimum_oath, sep = "", skip = 26, 
                           index.column = 1,  header = TRUE, format = "%Y-%m-%d", FUN = as.yearmon)) 

minimum_wage_qtr <- to.quarterly(minimum_wage)["1947/"]

minimum_wage_yr <- to.yearly(minimum_wage)["1947/"]

GDP_Quantity_Index <- "https://fred.stlouisfed.org/data/A191RA3Q086SBEA.txt"
GDP_Price_Index <- "https://fred.stlouisfed.org/data/A191RG3Q086SBEA.txt"
# Get data
GDP_Quantity <- as.xts(read.zoo(GDP_Quantity_Index, skip = 14, index.column = 1, 
                        header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))
GDP_Price    <- as.xts(read.zoo(GDP_Price_Index, skip = 14, index.column = 1, 
                             header = TRUE, format = "%Y-%m-%d", FUN = as.yearqtr))

base_year <- inflation_adjust(base_year=2009)

Real_minimum_wage <- minimum_wage_yr [,4]/base_year$adj_value

#Real_minimum_wage <- Fisher(minimum_wage_qtr[,4], GDP_Price, GDP_Quantity, base = 282)
#Real_minimum_wage
```

```{r message = FALSE, warning = FALSE, fig.width = 6, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Corporate Cash Flows without profits: Percentage of Real GDP"}
autoplot(Real_minimum_wage["/2016"]) +
        ylab("Real minimum wage") +
        xlab("Year") +
        scale_y_continuous(position = "right") +
        geom_vline(xintercept = c(2002, 2010)) +
        theme_bw()
```





## Card and Krueger

```{r, message = FALSE, warning = FALSE, tidy = TRUE}
## Card and Krueger
library(wooldridge)
data("discrim")

#str(discrim)
#lm(discrim$emp ~ discrim$wagest)
#plot(x=discrim$emp, y = discrim$wagest)

ggplot(data=discrim, aes(x=emp, y=wagest)) + 
        geom_point() +
        geom_smooth(method = "lm")

ggplot(data=discrim, aes(y=emp2, x=wagest2)) + 
        geom_point() +
        facet_grid(. ~ state) +
        geom_smooth(method = "lm")


```







